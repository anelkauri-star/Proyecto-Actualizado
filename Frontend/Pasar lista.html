<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lector de Códigos QR</title>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* Fuentes */
        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            background-color: #fce4ec; /* Un rosa muy claro */
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            color: #333;
        }

        /* Barra de navegación superior */
        .navbar {
            background-color: #fff;
            padding: 15px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .navbar-left, .navbar-right {
            display: flex;
            align-items: center;
        }

        .navbar a {
            text-decoration: none;
            color: #ff4081; /* Rosa vibrante */
            font-weight: 600;
            margin-left: 30px;
            font-size: 1.1em;
            transition: color 0.3s ease;
        }

        .navbar a:hover {
            color: #d81b60; /* Rosa más oscuro al pasar el ratón */
        }

        .navbar .active {
            color: #ff4081;
            font-weight: 700;
        }

        .navbar-left a:first-child {
            margin-left: 0;
        }

        /* Contenido principal */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            justify-content: center; /* Centrar verticalmente */
        }

        h1.page-title {
            color: #555;
            font-size: 2.8em;
            margin-bottom: 40px;
            font-weight: 600;
            text-align: center;
        }

        /* Contenedor del lector QR */
        .qr-reader-container {
            background-color: #ffffff; /* Fondo blanco */
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px; /* Ancho máximo */
            box-sizing: border-box;
            text-align: center;
            margin-bottom: 20px;
        }

        #videoElement {
            width: 100%;
            max-width: 100%;
            height: auto; /* Mantiene la relación de aspecto */
            border-radius: 8px;
            background-color: #333; /* Fondo oscuro mientras carga */
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transform: scaleX(-1); /* Refleja la imagen para simular espejo (si es cámara frontal) */
            /* Si quieres la cámara trasera sin reflejo, quita transform: scaleX(-1); */
        }

        #canvasElement {
            display: none; /* El canvas se usa para procesar la imagen, no para mostrarla */
        }

        #qr-result {
            font-size: 1.5em;
            color: #d81b60; /* Rosa oscuro */
            font-weight: 700;
            margin-top: 20px;
            word-break: break-all; /* Rompe palabras largas */
        }

        #qr-result small {
            display: block;
            font-size: 0.7em;
            color: #555;
            margin-top: 5px;
        }

        .status-message {
            font-size: 1.1em;
            color: #666;
            margin-top: 15px;
        }

        /* Botones de control */
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .control-buttons button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .control-buttons .start-button {
            background-color: #ff4081; /* Rosa vibrante */
            color: #fff;
        }

        .control-buttons .start-button:hover {
            background-color: #d81b60;
        }

        .control-buttons .stop-button {
            background-color: #333; /* Gris oscuro */
            color: #fff;
        }

        .control-buttons .stop-button:hover {
            background-color: #000;
        }

        /* Media Queries para responsividad */
        @media (max-width: 900px) {
            .navbar {
                flex-direction: column;
                padding: 15px 20px;
            }
            .navbar-left, .navbar-right {
                flex-direction: column;
                align-items: flex-start;
                margin-top: 10px;
            }
            .navbar a {
                margin-left: 0;
                margin-bottom: 10px;
            }
            .navbar-right {
                margin-top: 20px;
            }
            .qr-reader-container {
                padding: 20px;
                max-width: 95%;
            }
        }

        @media (max-width: 600px) {
            .navbar {
                padding: 10px;
            }
            .navbar a {
                font-size: 1em;
                margin-bottom: 8px;
            }
            h1.page-title {
                font-size: 2.2em;
                margin-bottom: 30px;
            }
            .control-buttons {
                flex-direction: column;
                gap: 15px;
            }
            .control-buttons button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header class="navbar">
        <div class="navbar-left">
            <a href="menu_principal_admin.html" class="active">Inicio</a>
            <a href="#">Carreras</a>
            <a href="redes sociales.html">Redes Sociales</a>
        </div>
        <div class="navbar-right">
            <a href="#">Eventos destacados</a>
            <a href="Mapa.html">Mapa</a>
            <a href="logout.php">Cerrar Sesión</a>
        </div>
    </header>

    <main class="main-content">
        <h1 class="page-title">Lector de Códigos QR para Asistencia</h1>

        <div class="qr-reader-container">
            <p class="status-message" id="statusMessage">Iniciando cámara...</p>
            <video id="videoElement" autoplay playsinline></video>
            <canvas id="canvasElement"></canvas>

            <div id="qr-result">
                <small>Resultado del Código QR:</small>
                <br>
                <span>Esperando código QR...</span>
            </div>

            <div class="control-buttons">
                <button class="start-button" id="startButton">Iniciar Escáner</button>
                <button class="stop-button" id="stopButton">Detener Escáner</button>
            </div>
        </div>
    </main>

    <script>
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasElement');
        const resultDiv = document.getElementById('qr-result').querySelector('span');
        const statusMessage = document.getElementById('statusMessage');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const ctx = canvas.getContext('2d');

        let scanning = false;
        let stream = null; // Para almacenar el objeto de la cámara

        // Función para iniciar el escáner
        async function startScanner() {
            if (scanning) return; // Ya está escaneando

            try {
                // Solicitar acceso a la cámara. 'environment' prefiere la cámara trasera.
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                video.srcObject = stream;
                video.setAttribute('playsinline', true); // Necesario para iOS
                await video.play();
                statusMessage.textContent = "Cámara iniciada. Apunte al código QR.";
                scanning = true;
                requestAnimationFrame(tick);
            } catch (err) {
                console.error("Error al acceder a la cámara: ", err);
                statusMessage.textContent = `Error: No se pudo acceder a la cámara. Asegúrate de tener una cámara y dar permiso. (${err.name})`;
                resultDiv.textContent = "No se pudo iniciar el escáner.";
            }
        }

        // Función para detener el escáner
        function stopScanner() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop()); // Detiene todas las pistas del stream (cámara)
                video.srcObject = null; // Limpia el video
            }
            scanning = false;
            resultDiv.textContent = "Esperando código QR...";
            statusMessage.textContent = "Escáner detenido.";
            // Limpia el canvas si se ha dibujado algo
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function tick() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                // Asegúrate de que el canvas tenga el mismo tamaño que el video
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert", // Puede ayudar en algunos casos
                });

                if (code) {
                    stopScanner(); // Detener el escáner una vez que se encuentra un QR
                    resultDiv.textContent = code.data;
                    statusMessage.textContent = "¡Código QR detectado y leído!";
                    // Opcional: dibujar el cuadrado de detección
                    drawLine(code.location.topLeftCorner, code.location.topRightCorner);
                    drawLine(code.location.topRightCorner, code.location.bottomRightCorner);
                    drawLine(code.location.bottomRightCorner, code.location.bottomLeftCorner);
                    drawLine(code.location.bottomLeftCorner, code.location.topLeftCorner);

                    // Aquí es donde procesarías el código QR.
                    // Por ejemplo, enviarlo a un servidor PHP para registrar asistencia.
                    // console.log("Código QR leído:", code.data);
                    // alert("QR Leído: " + code.data); // Para prueba
                }
            }
            if (scanning) { // Solo si todavía estamos escaneando, pedir el siguiente frame
                requestAnimationFrame(tick);
            }
        }

        function drawLine(begin, end) {
            ctx.beginPath();
            ctx.moveTo(begin.x, begin.y);
            ctx.lineTo(end.x, end.y);
            ctx.lineWidth = 4;
            ctx.strokeStyle = "#FF3B58"; // Color para el recuadro
            ctx.stroke();
        }

        // Asignar eventos a los botones
        startButton.addEventListener('click', startScanner);
        stopButton.addEventListener('click', stopScanner);

        // Intentar iniciar el escáner automáticamente al cargar la página
        // startScanner(); // Descomentar si quieres que inicie automáticamente
    </script>
</body>
</html>